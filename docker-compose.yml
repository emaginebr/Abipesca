services:
  postgres:
    image: postgres:16-alpine
    container_name: abipesca-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${DB_NAME:-abipesca}
      DB_USER: ${DB_USER:-abipesca_user}
      DB_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
      - ./docker/postgres/migrations.sql:/docker-entrypoint-initdb.d/migrations.sql:ro
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  ztools-api:
    build:
      context: ./zTools
      dockerfile: Dockerfile
    container_name: abipesca-ztools-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ChatGPT__ApiKey=${CHATGPT_APIKEY}
      - ChatGPT__ApiUrl=${CHATGPT_APIURL}
      - ChatGPT__Model=${CHATGPT_MODEL}
      - ChatGPT__ImageApiUrl=${CHATGPT_IMAGEAPIURL}
      - MailerSend__MailSender=${MAILERSEND__MAILSENDER}
      - MailerSend__ApiURL=${MAILERSEND__APIURL}
      - MailerSend__ApiToken=${MAILERSEND__APITOKEN}
      - S3__AccessKey=${S3__ACCESSKEY}
      - S3__SecretKey=${S3__SECRETKEY}
      - S3__Endpoint=${S3__ENDPOINT}
    networks:
      - abipesca-network

  nauth-api:
    build:
      context: ./NAuth
      dockerfile: Dockerfile
    container_name: abipesca-nauth-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:80
      - ConnectionStrings__NAuthContext=Host=postgres;Port=5432;Database=${DB_NAME:-abipesca};Username=${DB_USER:-abipesca_user};Password=${DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - zTools__ApiUrl=http://ztools-api:8080
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 3s
      start_period: 15s
      retries: 3

  nnews-api:
    build:
      context: ./NNews
      dockerfile: NNews.API.Dockerfile
    container_name: abipesca-nnews-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__NNewsContext=Host=postgres;Port=5432;Database=${DB_NAME:-abipesca};Username=${DB_USER:-abipesca_user};Password=${DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - zTools__ApiUrl=http://ztools-api:8080
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network

  bazzuca-api:
    build:
      context: ./BazzucaMedia
      dockerfile: BazzucaAPI.Dockerfile
    container_name: abipesca-bazzuca-api
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__BazzucaContext=Host=postgres;Port=5432;Database=${DB_NAME:-abipesca};Username=${DB_USER:-abipesca_user};Password=${DB_PASSWORD}
      - NAuth__JwtSecret=${JWT_SECRET}
      - zTools__ApiUrl=http://ztools-api:8080
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - abipesca-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    container_name: abipesca-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      - nauth-api
      - nnews-api
      - bazzuca-api
    networks:
      - abipesca-network

volumes:
  postgres_data:
    driver: local

networks:
  abipesca-network:
    name: abipesca-network
    driver: bridge
